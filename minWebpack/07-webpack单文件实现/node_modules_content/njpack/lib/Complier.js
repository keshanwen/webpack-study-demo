const fs = require("fs");
const ejs = require("ejs");
const path = require("path");

class Complier {
    constructor(config){
        // 保存配置
        this.config = config;
        // 保存模块的依赖
        this.modules = {};
    }
    run(){
        this.buildModule();
        this.emitFile();
    }
    buildModule(){
        let code = this.getSource(this.config.entry);
        // console.log(code);
        this.modules[this.config.entry] = code;
        console.log(this.modules);
    }
    getSource(modulePath){
        return fs.readFileSync(modulePath, "utf8");
    }
    emitFile(){
        // 1.读取EJS模板
        let templatePath = path.resolve(__dirname, "main.ejs");
        let template = fs.readFileSync(templatePath, "utf8");
        // console.log(template);
        // 2.利用变量替换模板中的内容
        let resultCode = ejs.render(template, {entryId: this.config.entry, modules: this.modules});
        // console.log(resultCode);
        // 3.将最终的内容写入到文件中
        // 3.1拿到输出的目录
        let outputDir = this.config.output.path;
        // console.log(outputDir);
        if(!fs.existsSync(outputDir)){
            fs.mkdirSync(outputDir);
        }
        let outputPath = path.resolve(outputDir, this.config.output.filename)
;
        fs.writeFileSync(outputPath, resultCode);
    }
}
module.exports = Complier;